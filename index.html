<!DOCTYPE HTML>
<html>

<body>

    <table id="productTable" border="1" width="100%">
        <thead>
            <tr>
                <th>Название</th>
                <th>Категория</th>
                <th>Количество</th>
                <th>Цена</th>
                <th>ID</th>
            </tr>
        </thead>
    </table>
    <button onclick="addRow()">Добавить</button>
    <p><a onclick="transferData(event)" href="cart.html">Корзина</a></p>

    
    <script>
        const apple = {
            name: "Яблоко",
            category: "Фрукты",
            count: 4,
            price: 100,
            id: 1
        };

        const cherry = {
            name: "Вишня",
            category: "Ягоды",
            count: 100,
            price: 500,
            id: 2
        };

        const cucumber = {
            name: "Огурец",
            category: "Овощи",
            count: 2,
            price: 50,
            id: 3
        };

        let products = JSON.parse(sessionStorage.getItem('products'))
        if(products === null) {
            products = []
            products.push(...[apple, cherry, cucumber])
        }

        const cart = JSON.parse(sessionStorage.getItem('cart'))
        if(cart === null) cart = []

        const productTable = document.getElementById('productTable');
        const tbody = document.createElement('tbody');

        let editingId = 0;
        const editingRow = document.createElement('tr');

        fillTable();

        function transferData() {
            if(editingId) {
                if(!saveEditingRow()){
                    event.preventDefault();
                    return;
                }
            }

            sessionStorage.setItem('cart', JSON.stringify(cart));
            sessionStorage.setItem('products', JSON.stringify(products));
        }

        function saveEditingRow() {
            const inputs = Array.from(editingRow.querySelectorAll('input'));
            const divs = Array.from(editingRow.querySelectorAll('div'));

            const editingProduct = products.find(product => product.id == editingId)

            if(inputs[0].value.trim() === '') {
                divs[0].innerHTML = 'Введите имя продукта'
                return false
            }
            else if(!isValidProductCount(inputs[1].value)){
                divs[1].innerHTML = 'Введите корректное количество'
                return false
            }
            else if(!isValidPrice(inputs[2].value)) {
                divs[2].innerHTML = 'Введите корректную цену'
                return false
            }
            else {
                getRowData(editingProduct)
                return true
            }
        }

        function getInputRow(product) {
            editingId = product.id;

            const inputName = document.createElement('input');
            inputName.type = 'text';
            inputName.value = product.name;

            const errEmptyName = document.createElement('div');
            errEmptyName.style.color = 'red';
            errEmptyName.innerHTML = ''

            inputName.addEventListener('input', () =>{
                if(inputName.value.trim() === '') {
                    errEmptyName.innerHTML = 'Введите имя продукта'
                }
                else {
                    errEmptyName.innerHTML = ''
                }
                
            })

            const selectCategory = document.createElement('select');
            const options = ['Фрукты', 'Овощи', 'Ягоды'];
            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectCategory.appendChild(option);
            });

            selectCategory.value = product.category;

            const inputCount = document.createElement('input');
            inputCount.type = 'number';
            inputCount.value = product.count;

            const errNegativeCount = document.createElement('div');
            errNegativeCount.style.color = 'red';
            errNegativeCount.innerHTML = ''

            inputCount.addEventListener('input', () =>{
                if(isValidProductCount(inputCount.value)) {
                    errNegativeCount.innerHTML = ''                
                }
                else {
                    errNegativeCount.innerHTML = 'Введите корректное количество'
                }
                
            })

            const inputPrice = document.createElement('input');
            inputPrice.type = 'number';
            inputPrice.value = product.price;
 
            const errNotPositivePrice = document.createElement('div');
            errNotPositivePrice.style.color = 'red';
            errNotPositivePrice.innerHTML = ''

            inputPrice.addEventListener('input', () =>{
                if(isValidPrice(inputPrice.value)) {
                    errNotPositivePrice.innerHTML = ''
                }
                else {
                    errNotPositivePrice.innerHTML = 'Введите корректную цену'
                }
                
            })

            const saveButton = document.createElement('button');
            saveButton.textContent = 'Сохранить';

            saveButton.addEventListener('click', () => {
                saveEditingRow()
            });

            let td = document.createElement('td');
            td.appendChild(inputName);
            td.appendChild(errEmptyName);
            editingRow.appendChild(td);

            td = document.createElement('td');
            td.appendChild(selectCategory);
            editingRow.appendChild(td);

            td = document.createElement('td');
            td.appendChild(inputCount);
            td.appendChild(errNegativeCount);
            editingRow.appendChild(td);

            td = document.createElement('td');
            td.appendChild(inputPrice);
            td.appendChild(errNotPositivePrice);
            editingRow.appendChild(td);

            td = document.createElement('td');
            td.textContent = product.id;
            editingRow.appendChild(td);

            editingRow.appendChild(saveButton);
        }

        function getRowData(product) {

            const inputs = editingRow.querySelectorAll('input, select');

            let i = 0;
            for(let key in product) {
                if (key === 'id') continue;
                product[key] = inputs[i].value;
                i++;
            }

            const editingCartIndex = cart.map(cartProduct => cartProduct.id ).indexOf(product.id)
            if(editingCartIndex != -1) {
                cart[editingCartIndex].maxCount = product.count
            }

            while (editingRow.firstChild) {
                editingRow.removeChild(editingRow.firstChild);
            }
            editingRow.parentNode.removeChild(editingRow)

            editingId = 0;
            fillTable();
        }

        function addRow() {

            if(editingId) {
                if(!saveEditingRow()) return
            }

            const newProduct = {
                name: '',
                category: 'Фрукты',
                count: 0,
                price: 0,
                id: getNewId()
            };
            products.push(newProduct);

            getInputRow(newProduct)

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Отмена';

            cancelButton.addEventListener('click', () => {
                while (editingRow.firstChild) {
                    editingRow.removeChild(editingRow.firstChild);
                }
                editingRow.parentNode.removeChild(editingRow)

                editingId = 0;
                products.pop()
                fillTable();
            });

            editingRow.appendChild(cancelButton);

            tbody.appendChild(editingRow);
            productTable.appendChild(tbody);
       
        }

        function editRow(id) {
            const index = products.findIndex(item => item.id === id);
            if (index === -1) return;

            let deletedRow = document.querySelector(`#productTable tbody tr[data-id="${id}"]`);

            while (deletedRow.firstChild) {
                deletedRow.removeChild(deletedRow.firstChild);
            }
            deletedRow.parentNode.removeChild(deletedRow);

            getInputRow(products[index]);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Отмена';

            cancelButton.addEventListener('click', () => {
                while (editingRow.firstChild) {
                    editingRow.removeChild(editingRow.firstChild);
                }
                editingRow.parentNode.removeChild(editingRow)

                editingId = 0;
                fillTable();
            });

            editingRow.appendChild(cancelButton);
            fillTable();
        }

        function fillTable() {
            while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
            }

            products.forEach(product => {
                if(product.id == editingId) {
                    tbody.appendChild(editingRow); 
                }
                else {
                    const newRow  = document.createElement('tr');
                    fillRow(newRow, product)
                    tbody.appendChild(newRow);     
                }     
             });

             productTable.appendChild(tbody);   
        }

        function fillRow(row, product) {
            row.dataset.id = product.id;

            Object.values(product).forEach(value => {
                const td = document.createElement('td');
                td.textContent = value;
                row.appendChild(td);
            })

            const editButton = document.createElement('button');
            editButton.textContent = 'Редактировать';
            row.appendChild(editButton);

            editButton.addEventListener('click', () => {
                if(editingId) {
                    if(!saveEditingRow()) return
                }

                editRow(product.id);
            });

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Удалить';
            row.appendChild(deleteButton);

            deleteButton.addEventListener('click', () => {
                if(editingId) {
                    if(!saveEditingRow()) return
                }

                products.splice(products.indexOf(product), 1);
                cart.splice(cart.indexOf(cartProduct => cartProduct.id === product.id), 1);

                fillTable();
            });

            const td = document.createElement('td');
            const inputCartCount = document.createElement('input');
            inputCartCount.type = 'number'
            inputCartCount.value = 1

            const errWrongCartCount = document.createElement('div');
            errWrongCartCount.style.color = 'red';
            errWrongCartCount.innerHTML = ''

            inputCartCount.addEventListener('input', () => {
                if(isValidCartCount(inputCartCount.value) && parseInt(inputCartCount.value) <= product.count) {
                    errWrongCartCount.innerHTML = ''                     
                }
                else {
                    errWrongCartCount.innerHTML = 'Введите корректное количество'
                }
            })

            td.appendChild(inputCartCount);
            td.appendChild(errWrongCartCount);
            row.appendChild(td);

            const addToCartButton = document.createElement('button');
            addToCartButton.textContent = 'В корзину';
            row.appendChild(addToCartButton);

            addToCartButton.addEventListener('click', () => {
                if(editingId) {
                    if(!saveEditingRow()) return
                }
 
                if(cart.some(cartProduct => cartProduct.id === product.id)) {
                    const editingCartIndex = cart.map(cartProduct => cartProduct.id ).indexOf(product.id)

                    cart[editingCartIndex].name = product.name
                    cart[editingCartIndex].count = inputCartCount.value
                    cart[editingCartIndex].maxCount = product.count
                    cart[editingCartIndex].price = product.price
                }
                else {
                    const newCartProduct = {
                        name: product.name,
                        count: inputCartCount.value,
                        maxCount: product.count,
                        price: product.price,
                        id: product.id
                    }

                    cart.push(newCartProduct)
                }

                fillTable();
            });
        }
    
        function isValidProductCount(value) {
            const trimmedValue = value.trim();
            const num = parseInt(trimmedValue);
            return !isNaN(num) && trimmedValue !== '' && num.toString() === trimmedValue && num >= 0;
        }

        function isValidCartCount(value) {
            const trimmedValue = value.trim();
            const num = parseInt(trimmedValue);
            return !isNaN(num) && trimmedValue !== '' && num.toString() === trimmedValue && num > 0;
        }

        function isValidPrice(value) {
            const trimmedValue = value.trim();
            const num = parseFloat(trimmedValue);
            return !isNaN(num) && trimmedValue !== '' && num.toString() === trimmedValue && num > 0;
        }

        function getNewId() {

            if(products.length === 0) {
                return 1;
            }

            const ids = products.map(i => i.id).sort((a,b) => a-b)

            for (let i = 0; i < ids.length; i++) {
                if (ids[i] !== i + 1) {
                return i + 1;
                }
            }
            return ids.length + 1;
        }
    </script>

</body>

</html>
